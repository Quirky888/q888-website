---
import Layout from "../layouts/Layout.astro";
import SystemMeta from "../components/SystemMeta.astro";
import SlimNav from "../components/SlimNav.astro";
import LandingHero from "../components/LandingHero.astro";
import ProjectsThreshold from "../components/ProjectsThreshold.astro";
import ProjectDrawer from "../components/ProjectDrawer.astro";
import InfociganSection from "../components/InfociganSection.astro";
import ContactSection from "../components/ContactSection.astro";
---

<Layout title="Q888 â€” Identity">
  <SlimNav />
  <SystemMeta position="top" />
  
  <main class="relative min-h-screen pt-10 md:pt-11">
    <section id="landing" data-section="landing" class="relative">
      <LandingHero />
    </section>

    <section id="projects" data-section="projects">
      <ProjectsThreshold />
    </section>

    <InfociganSection />

    <ContactSection />
  </main>

  <SystemMeta position="bottom" />
  <ProjectDrawer />

  <script>
    import { initThresholdMotion } from "../scripts/thresholdMotion";
    import { initProjectDrawer, destroyProjectDrawer } from "../scripts/drawerNav";
    import { initSystemMetaState, destroySystemMetaState } from "../scripts/systemMetaState";
    import { initNavScroll, destroyNavScroll } from "../scripts/navScroll";
    import { initInfociganPortal, destroyInfociganPortal } from "../scripts/infociganPortal";
    import { initGraphiteMist, destroyGraphiteMist } from "../scripts/graphiteMist";

    let didInit = false;
    let didBindLifecycle = false;

    function init() {
      if (didInit) return;
      
      initNavScroll();
      initSystemMetaState();
      initThresholdMotion();
      initProjectDrawer();
      initInfociganPortal();
      initGraphiteMist();
      
      didInit = true;
    }

    function cleanup() {
      if (!didInit) return;

      destroyNavScroll();
      destroySystemMetaState();
      destroyProjectDrawer();
      destroyInfociganPortal();
      destroyGraphiteMist();
      
      didInit = false;
    }

    if (!didBindLifecycle) {
      // Initial load fallback
      if (document.readyState !== "loading") {
        init();
      } else {
        document.addEventListener("DOMContentLoaded", init, { once: true });
      }

      document.addEventListener("astro:page-load", init);
      document.addEventListener("astro:before-swap", cleanup);
      window.addEventListener("beforeunload", cleanup);
      didBindLifecycle = true;
    }
  </script>
</Layout>
